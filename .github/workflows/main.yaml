name: Lint + Gemini Summary

on:
  pull_request:

jobs:
  lint-and-summarize:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      # ‚¨áÔ∏è Checkout repository
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # ‚¨áÔ∏è Run Super-Linter
      - name: Run Super-Linter
        id: superlinter
        uses: super-linter/super-linter@v8.3.0
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REMOVE_ANSI_COLOR_CODES_FROM_OUTPUT: "true"
          LOG_LEVEL: "DEBUG"
          # These cause the linter to write full summaries
          ENABLE_GITHUB_ACTIONS_STEP_SUMMARY: "true"
          SAVE_SUPER_LINTER_SUMMARY: "true"

      # ‚¨áÔ∏è Capture full Super-Linter logs
      - name: Capture Super-Linter logs
        run: |
          echo "=== FULL SUPER-LINTER JOB SUMMARY ===" > lint.log

          # Print the GitHub Actions step summary file (full details)
          cat "$GITHUB_STEP_SUMMARY" >> lint.log || true

          # If Super-Linter saved a summary file in workspace
          if [ -d "${GITHUB_WORKSPACE}/${SUPER_LINTER_OUTPUT_DIRECTORY_NAME}" ]; then
            echo "=== SAVED SUPER-LINTER OUTPUT ===" >> lint.log
            find "${GITHUB_WORKSPACE}/${SUPER_LINTER_OUTPUT_DIRECTORY_NAME}" -type f -print >> lint.log
            cat "${GITHUB_WORKSPACE}/${SUPER_LINTER_OUTPUT_DIRECTORY_NAME}"/* >> lint.log || true
          fi

          # Trim to first 1000 lines
          head -n 1000 lint.log > lint_trimmed.log

          echo "üü¢ Logs captured, trimmed to first 1000 lines:"
          cat lint_trimmed.log

        shell: /usr/bin/bash

      # ‚¨áÔ∏è Summarize logs with Gemini
      - name: Summarize Lint Logs with Gemini
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.16
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            The following are the Super-Linter results from a pull request CI run:

            ```
            $(cat lint_trimmed.log)
            ```

            1) Summarize the lint results
            2) Highlight *security-relevant* issues first
            3) Give concrete fix commands or suggestions

      # ‚¨áÔ∏è Post summary as a PR comment
      - name: Comment Summary on Pull Request
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "$GEMINI_OUTPUT"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
