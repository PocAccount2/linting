name: Lint + Gemini Summary

on:
  pull_request:

jobs:
  lint-and-summarize:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: read
      statuses: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # 1️⃣ Run Super-Linter (do NOT stop job on errors)
      - name: Run Super-Linter
        id: superlinter
        uses: super-linter/super-linter@v8.3.0
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REMOVE_ANSI_COLOR_CODES_FROM_OUTPUT: "true"

      # 2️⃣ Capture logs
      - name: Capture Super-Linter logs
        run: |
          echo "Saving Super-Linter logs..."
          cat $GITHUB_WORKSPACE/super-linter.log > lint.log || true
          head -n 1500 lint.log > lint_trimmed.log

      # 3️⃣ Summarize with Gemini
      - name: Summarize Lint Logs with Gemini
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.16
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            These are Super-Linter results from a pull request.

            ```
            $(cat lint_trimmed.log)
            ```

            Please:
            - Summarize the failures by tool
            - Identify the highest-risk issues
            - Give concrete fix suggestions

      # 4️⃣ Comment on PR
      - name: Comment Summary on Pull Request
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "$GEMINI_OUTPUT"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
