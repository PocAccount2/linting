name: Lint + Gemini Summary

on:
  pull_request:

jobs:
  lint-and-summarize:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # 1️⃣ Run Super-Linter and capture output
      - name: Run Super-Linter
        id: superlinter
        uses: super-linter/super-linter@v8.3.0
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REMOVE_ANSI_COLOR_CODES_FROM_OUTPUT: "true"
          LOG_LEVEL: "DEBUG"

      # 2️⃣ Extract logs from GitHub Actions log stream
      - name: Capture Super-Linter logs
        run: |
          echo "Saving Super-Linter logs..."
          {
            echo "=== SUPER LINTER OUTPUT ==="
            grep -E "ERROR|NOTICE|Successfully linted|Errors found" \
              "$GITHUB_STEP_SUMMARY" || true
          } > lint.log

          head -n 1000 lint.log > lint_trimmed.log

          echo "Logs captured:"
          cat lint_trimmed.log

      # 3️⃣ Summarize with Gemini
      - name: Summarize Lint Logs with Gemini
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.16
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            These are Super-Linter results from a pull request:

            ```
            $(cat lint_trimmed.log)
            ```

            Please:
            1) Summarize failed linters
            2) Highlight security-relevant issues first
            3) Provide concrete fix commands

      # 4️⃣ Comment on PR
      - name: Comment Summary on Pull Request
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "$GEMINI_OUTPUT"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
